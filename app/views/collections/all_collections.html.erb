<h1 class="my-3 text-center">All Collections</h1>

<div class="mb-4">
  <% if user_signed_in? && current_user.admin? %>
    <%= link_to 'New Collection', new_collection_path, class: 'btn btn-primary' %>
  <% end %>
  <button id="exportCsv" class="btn btn-success ms-3">Export to CSV</button>
</div>

<div class="row mb-3">
  <div class="col-md-6">
    <label for="categoryFilter" class="form-label">Filter by Category:</label>
    <select id="categoryFilter" class="form-select">
      <option value="">All Categories</option>
      <% ["Books", "Signs", "Silverware", "Other"].each do |category| %>
        <option value="<%= category %>"><%= category %></option>
      <% end %>
    </select>
  </div>
  <div class="col-md-6">
    <label for="userFilter" class="form-label">Filter by User ID:</label>
    <input type="number" id="userFilter" class="form-control" placeholder="Enter User ID">
  </div>
</div>

<table class="table table-striped table-responsive-md">
  <thead>
    <tr>
      <th>Collection ID</th>
      <th>User ID</th>
      <th>Collection Name</th>
      <th>Category</th>
      <th>Image URL</th>
      <% if user_signed_in? && current_user.admin? %>
        <th>Actions</th>
      <% end %>
    </tr>
  </thead>
  <tbody id="collectionsTable">
    <% @collections.each do |collection| %>
      <tr data-category="<%= collection.category %>" data-user-id="<%= collection.user_id %>">
        <td><%= collection.id %></td>
        <td><%= collection.user_id %></td>
        <td><%= link_to collection.name, collection %></td>
        <td><%= collection.category %></td>
        <td>
          <% if collection.image_url.present? %>
            <img src="<%= collection.image_url %>" alt="<%= collection.name %>" class="img-fluid" style="max-width: 100px;">
          <% else %>
            N/A
          <% end %>
        </td>
        <% if user_signed_in? && current_user.admin? %>
          <td>
            <%= link_to 'Edit', edit_collection_path(collection), class: 'btn btn-secondary btn-sm' %>
            <%= link_to 'Delete', collection, method: :delete, data: { confirm: 'Are you sure?' }, class: 'btn btn-danger btn-sm' %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const categoryFilter = document.getElementById('categoryFilter');
    const userFilter = document.getElementById('userFilter');
    const tableRows = document.querySelectorAll('#collectionsTable tr');

    const filterTable = () => {
      const category = categoryFilter.value;
      const userId = userFilter.value.trim();

      tableRows.forEach(row => {
        const rowCategory = row.getAttribute('data-category');
        const rowUserId = row.getAttribute('data-user-id');

        let showRow = true;

        if (category && rowCategory !== category) {
          showRow = false;
        }

        if (userId && rowUserId !== userId) {
          showRow = false;
        }

        row.style.display = showRow ? '' : 'none';
      });
    };

    categoryFilter.addEventListener('change', filterTable);
    userFilter.addEventListener('input', filterTable);

    document.getElementById('exportCsv').addEventListener('click', () => {
      const visibleRows = document.querySelectorAll('#collectionsTable tr:not([style*="display: none"])');
      let csvContent = "data:text/csv;charset=utf-8,Collection ID,User ID,Collection Name,Category,Image URL\n";

      visibleRows.forEach(row => {
        const cols = row.querySelectorAll('td');
        let rowData = [];
        cols.forEach(col => {
          if (col.querySelector('img')) {
            rowData.push(col.querySelector('img').src);
          } else {
            rowData.push(col.innerText);
          }
        });
        csvContent += rowData.join(",") + "\n";
      });

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement('a');
      link.setAttribute('href', encodedUri);
      link.setAttribute('download', 'collections.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  });
</script>
